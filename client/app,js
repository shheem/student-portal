// Stelle sicher: Server l√§uft auf http://localhost:5000
const API = "http://localhost:5000/api";

document.addEventListener("DOMContentLoaded", () => {
  // Tabs
  const tabStudent = document.getElementById("tab-student");
  const tabTeacher = document.getElementById("tab-teacher");
  const studentView = document.getElementById("student-view");
  const teacherView = document.getElementById("teacher-view");

  tabStudent.addEventListener("click", () => {
    tabStudent.classList.add("active");
    tabTeacher.classList.remove("active");
    studentView.classList.add("active");
    teacherView.classList.remove("active");
  });

  tabTeacher.addEventListener("click", () => {
    tabTeacher.classList.add("active");
    tabStudent.classList.remove("active");
    teacherView.classList.add("active");
    studentView.classList.remove("active");
  });

  // --- Student: Noten anzeigen ---
  const gradesBtn = document.getElementById("checkGradesBtn");
  const gradesBox = document.getElementById("gradesResult");

  gradesBtn.addEventListener("click", async () => {
    const id = document.getElementById("studentIdInput").value.trim();
    gradesBox.classList.add("hidden");
    gradesBox.innerHTML = "";

    if (!id) {
      gradesBox.innerHTML = "<p>‚ùå Bitte eine ID eingeben.</p>";
      gradesBox.classList.remove("hidden");
      return;
    }

    try {
      const res = await fetch(`${API}/student/grades`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ studentId: id }),
      });

      const data = await res.json();
      if (!res.ok) {
        throw new Error(data.error || "Fehler beim Laden der Noten.");
      }

      gradesBox.innerHTML = `
        <h3>${data.name} (ID: ${data.id})</h3>
        <ul>
          ${data.grades
            .map((g) => `<li>${g.course}: <b>${g.grade}</b></li>`)
            .join("")}
        </ul>
      `;
      gradesBox.classList.remove("hidden");
    } catch (e) {
      gradesBox.innerHTML = `<p>‚ùå ${e.message}</p>`;
      gradesBox.classList.remove("hidden");
    }
  });

  // --- Vorlesungen laden ---
  async function loadLectures() {
    const list = document.getElementById("lecturesList");
    list.innerHTML = "Loading...";

    try {
      const res = await fetch(`${API}/lectures`);
      const lectures = await res.json();

      if (!Array.isArray(lectures) || lectures.length === 0) {
        list.innerHTML = "<p>No lectures uploaded yet.</p>";
        return;
      }

      list.innerHTML = `
        <ul>
          ${lectures
            .map(
              (l) => `
            <li>
              üìÑ ${l.title} ‚Äì
              <a href="http://localhost:5000/uploads/${l.fileName}" target="_blank">download</a>
              <button data-id="${l.id}" class="delete-lecture-btn">‚ùå Delete</button>
            </li>
          `
            )
            .join("")}
        </ul>
      `;

      // Delete-Buttons anklemmen
      document
        .querySelectorAll(".delete-lecture-btn")
        .forEach((btn) => {
          btn.addEventListener("click", async () => {
            const id = btn.getAttribute("data-id");
            if (!confirm("Are you sure you want to delete this file?")) return;

            try {
              const res = await fetch(`${API}/teacher/lectures/${id}`, {
                method: "DELETE",
              });

              if (res.ok) {
                alert("‚úÖ Deleted!");
                loadLectures();
              } else {
                alert("‚ùå Failed to delete");
              }
            } catch {
              alert("‚ùå Failed to delete");
            }
          });
        });
    } catch (e) {
      list.innerHTML = "<p>‚ùå Fehler beim Laden der Vorlesungen.</p>";
    }
  }

  // --- Teacher Login ---
  const teacherLoginBtn = document.getElementById("teacherLoginBtn");
  const teacherArea = document.getElementById("teacherArea");

  teacherLoginBtn.addEventListener("click", async () => {
    const pw = document.getElementById("teacherPassword").value;

    try {
      const res = await fetch(`${API}/teacher/login`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ password: pw }),
      });

      if (res.ok) {
        teacherArea.classList.remove("hidden");
      } else {
        teacherArea.classList.add("hidden");
        alert("Wrong password");
      }
    } catch {
      alert("Login failed");
    }
  });

  // --- Upload Lecture ---
  const uploadBtn = document.getElementById("uploadLectureBtn");
  const uploadMsg = document.getElementById("uploadMsg");

  uploadBtn.addEventListener("click", async () => {
    const title = document.getElementById("lectureTitle").value;
    const file = document.getElementById("lectureFile").files[0];

    if (!file) {
      alert("Choose a file first!");
      return;
    }

    const form = new FormData();
    form.append("title", title);
    form.append("lecture", file);

    uploadMsg.textContent = "Uploading...";

    try {
      const res = await fetch(`${API}/teacher/lectures`, {
        method: "POST",
        body: form,
      });

      if (res.ok) {
        uploadMsg.textContent = "‚úÖ Uploaded!";
        document.getElementById("lectureTitle").value = "";
        document.getElementById("lectureFile").value = "";
        loadLectures();
      } else {
        uploadMsg.textContent = "‚ùå Upload failed";
      }
    } catch {
      uploadMsg.textContent = "‚ùå Upload failed";
    }
  });

  // Beim Laden gleich Vorlesungen holen
  loadLectures();
});
